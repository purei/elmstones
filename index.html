<html>
<head></head>
<body>
<script src="workers.js"></script>
<!-- <script name="Array.shuffle">
function shuffle(arr) {
  return arr.reduce(function(arr, elt) {
    arr.splice(~~(Math.random() * (arr.length + 1)), 0, elt)
    return arr
  }, [])
}
</script> -->
<script name="Match Setup">
commander1 = {health:5}
commander2 = {health:7}

unit0 = {attack:1,health:1,delay:0}
unit1 = {attack:1,health:3,delay:1}
unit2 = {attack:2,health:3,delay:2}

deck_fast = [unit2,unit1,unit0]
deck_slow = [unit2,unit1,unit0,unit0]

basic = match(commander1, deck_fast, commander2, deck_slow)

// matchup = match(commander1, deck_fast, commander2, deck_slow)
function match(commanderO, deckO, commanderD, deckD) {
  return {
    attacker: { player: { commander: commanderO, deck: deckO }, strategy: 0, dealer: 0 },
    defender: { player: { commander: commanderD, deck: deckD }, strategy: 0, dealer: 0 }
  }
}
</script>
<!-- ======================================================================= -->
<script name="Wiring">
stats = {}

function request(a,b,roundtrip) {
  var in_from = roundtrip[0]
  var in_to = roundtrip[1]
  var out_from = roundtrip[2]
  var out_to = roundtrip[3]
  var begin = Date.now()
  var key = in_to+"_"+out_from
  stats[key] = 0
  a.ports[in_from].subscribe(function(data) {
    begin = Date.now() // note when request began
    b.ports[in_to].send(data)
  })
  b.ports[out_from].subscribe(function(data) {
    stats[key] += Date.now() - begin // log time for this request
    a.ports[out_to].send(data)
  })
}
</script>
<!-- ======================================================================= -->
<!-- ======================================================================= -->
<script name="Main">

very_start = Date.now()

sim = Elm.Simulator.worker(); // FIXME, sims should be a pool
player = Elm.Player.worker();
brain = Elm.Brain.worker();


request(brain,sim,["resolve","requisition","report","results"])
  //brain.resolve -requisition-> requisition => sim.report -report-> brain.results

request(sim,player,["awaitChoice","choose","chosen","play"])
  //sim.awaitChoice -fight-> player.choose => player.chosen -hand_idx-> sim.play

brain.ports.analyze.send(basic)
setTimeout(function () {stats["total"] = Date.now()-very_start; console.log(stats)},  100)
setTimeout(function () {stats["total"] = Date.now()-very_start; console.log(stats)}, 1000)
setTimeout(function () {stats["total"] = Date.now()-very_start; console.log(stats)},10000)

</script>
</body>
</html>